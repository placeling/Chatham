
<div id="content_holder">
  <% content_for :head do %>
    <title><%= t("question.title") %></title>
  <% end %>

  <% content_for :javascript_includes do %>
    <script type="text/javascript"
      src="https://maps.googleapis.com/maps/api/js?sensor=false&libraries=places">
    </script>
  <% end %>


  <%= form_for(@question) do |f| %>
      <% if @question.errors.any? %>
          <div id="error_explanation">
            <h3><%= pluralize(@question.errors.count, "error") %> prohibited this question from being saved:</h3>

            <ul>
              <% @question.errors.full_messages.each do |msg| %>
                  <li><%= msg %></li>
              <% end %>
            </ul>
          </div>
      <% end %>

      <div class="field">
        <%= f.label t'question.city' %><br/>
        <%= f.text_field :city_name, :class=>"question_field_box", :placeholder=>t('question.city_prompt') %>
      </div>

      <div class="field">
        <%= f.label t'question.question' %><br/>
        <%= f.text_field :title, :class=>"question_field_box" %>
      </div>

      <%= f.hidden_field :country_code, :id=>"country_code" %>
      <input id="lat" name="question[location][]" type="hidden" value="<%= @question.location[0] %>">
      <input id="lng" name="question[location][]" type="hidden" value="<%= @question.location[1] %>">


      <div class="actions" style="float:left;">
        <%= f.submit :class=>"submit" %>
      </div>
  <% end %>

  <% content_for :javascript do %>

    <script type="text/javascript">

      $(document).ready(function(){

          $('#question_city_name').keypress(function(e){
              if ( e.which == 13 ) return false;
          });

          $("#question_city_name").focusout(function () {
              var firstResult = $(".pac-container .pac-item:first").text();

              var geocoder = new google.maps.Geocoder();
              geocoder.geocode({"address":firstResult }, function(results, status) {
                  if (status == google.maps.GeocoderStatus.OK) {
                      $("#question_city_name").val(firstResult);

                      for ( var i=0; i< results[0].address_components.length; i++){
                          component = results[0].address_components[i];

                          if ( jQuery.inArray( "country", component.types ) >= 0 ){
                              $("#country_code").val( component.short_name );
                              break;
                          }
                      }

                      $("#lat").val( results[0].geometry.location.lat() );
                      $("#lng").val( results[0].geometry.location.lng() );

                  }
              });
          });

          var input = document.getElementById('question_city_name');
          var autocomplete = new google.maps.places.Autocomplete(input);

          google.maps.event.addListener(autocomplete, 'place_changed', function() {
              var place = autocomplete.getPlace();
              console.debug( place );
              if ( place.geometry ){

                  for ( var i=0; i< place.address_components.length; i++){
                      component = place.address_components[i];

                      if ( jQuery.inArray( "country", component.types ) >= 0 ){
                          $("#country_code").val( component.short_name );
                          break;
                      }
                  }


                  $("#lat").val( place.geometry.location.lat() );
                  $("#lng").val( place.geometry.location.lng() );
              }
          });

       });

    </script>
  <% end %>


</div>

