<html>
<head>
  <base target="_parent"/>
  <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCtWBCKJwtHq7ME82vk3d7eUsRknvzgrAQ&sensor=false">
  </script>

  <%= javascript_include_tag "jquery" %>
  <%= javascript_include_tag "iframe/jsrender" %>
  <%= javascript_include_tag "iframe/jquery.ui.map" %>
  <%= javascript_include_tag "iframe/jquery.ui.map.extensions" %>

</head>
<script type="text/javascript">
    $(document).ready(function () {
        //$('#map_holder').width("100%");
        //$('#map_holder').height("100%");
        var placemarker = new google.maps.MarkerImage(
                'http://www.placeling.com/images/placemarker.png',
                new google.maps.Size(30, 32),
                new google.maps.Point(0, 0),
                new google.maps.Point(9, 32)
        );

        var myloc = new google.maps.MarkerImage('//maps.gstatic.com/mapfiles/mobile/mobileimgs2.png',
                new google.maps.Size(22, 22),
                new google.maps.Point(0, 18),
                new google.maps.Point(11, 11));


        $("#iframe_pan").click(function () {
            $('#map_canvas').gmap('getCurrentPosition', function (position, status) {
                if (status === 'OK') {
                    var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    $('#map_canvas').gmap('get', 'map').setOptions({'center':clientPosition});
                }
            });
            return false;
        });

        $('#map_canvas').gmap({ 'center':'<%= @user.location[0] %>, <%= @user.location[1] %>', 'zoom':14, panControl:false,
            zoomControl:true, mapTypeControl:false, scaleControl:true, streetViewControl:false,
            overviewMapControl:true }).bind('init', function (ev, map) {

                    $.getJSON('<%= user_perspectives_path(@user, :source=>"pinta") %>', function (data) {
                        $.each(data.perspectives, function (i, perspective) {
                            $('#map_canvas').gmap('addMarker', {
                                'position':new google.maps.LatLng(perspective.place.lat, perspective.place.lng), 'icon':placemarker
                            }).click(function () {
                                        $('#map_canvas').gmap('openInfoWindow', { 'content':$("#calloutTemplate").render(perspective) }, this);
                                    });
                        });
                    });

                });

        $('#map_canvas').gmap().bind('init', function (evt, map) {
            $('#map_canvas').gmap('getCurrentPosition', function (position, status) {
                if (status === 'OK') {
                    var clientPosition = new google.maps.LatLng(position.coords.latitude, position.coords.longitude);
                    $('#map_canvas').gmap('addMarker', {'position':clientPosition, clickable:false, 'icon':myloc});

                }
            });
        });
    });
</script>
<style type="text/css">

    * {
        margin: 0px;
        padding: 0px;
        font-family: 'Helvetica Neue', Helvetica, Arial, Sans-serif;
    }

    body {
        /* for Firefox */
        overflow-x: hidden;
        overflow-y: hidden;
    }

    #iframe_pan {
        position: absolute;
        right: 15px;
        top: 20px;
        z-index: 1;
    }

    a, a:link, a:visited {
        color: #1271b0;
        text-decoration: none;
    }

    a.no_highlight:focus, a.no_highlight:hover {
        text-decoration: none;
    }

    a:focus, a:hover {
        text-decoration: underline;
    }

    a img {
        border: 0;
    }

    #placeling_iframe_logo {
        float: left;
        margin-top: 3px;
        margin-left: 10px;
    }

    #placeling_iframe_spacer {
        float: right;
        margin-top: 3px;
        margin-right: 10px;
        width: 117px;
    }

    .filter_value a, a:link, a:hover, a:visited {
        color: #36757c;
    }

    .info_window {
        width: 300px;
        background: #F9F7F5;
        padding: 5px;
    }

    @media only screen
    and (max-width : 480px) {
        #placeling_iframe_logo, #placeling_iframe_spacer {
            display: none;
        }

        .info_window {
            width: 200px;
        }
    }

    .info_name {
        font-size: 18px;
        color: #567E79;
        font-weight: bold;
        padding-left: 3px;
    }

    .info_memo {
        max-height: 52px;
        overflow-y: auto;
        margin-top: -2px;
        padding-left: 4px;
        margin-bottom: 5px;
    }

    .info_memo p {
        font-family: Georgia, "Times New Roman", Serif;
        color: #6A6147;
        padding-top: 5px;
        font-size: 14px;
        color: #666666;
    }

    a.tag_link {
        text-decoration: none;
    }

    .highlighted_tag {
        background: #CA3342;
    }

    @font-face {
        font-family: MuseoSlab;
        src: url(<%= asset_path 'MuseoSlab.otf' %>);
    }


</style>
<body>
<script id="calloutTemplate" type="text/x-jsrender">
  <div class="info_window">
    <div class="info_name">
      <a href="{{>url}}">{{>place.name}}</a>
    </div>
    <div class="info_memo">
      <p>{{>memo }}</p>
    </div>
  </div>

</script>

<div id="map_holder" style="width:100%; height:100%">
  <div id="iframe_pan">
    <a href="#" id="iframe_tag_filter_link"><%= image_tag asset_path("pan.png") %></a>
  </div>
  <div id="map_canvas" style="width:100%; height:100%"></div>
</div>
</body>
</html>